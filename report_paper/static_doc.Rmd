---
title: "Atlas da Radiação Solar da ilha da Madeira"
author: "Ricardo Jorge Agrela Faria"
date: '`r format(Sys.Date())`'
output:
  html_document:
    fig_caption: yes
    theme: spacelab
    toc: yes
    toc_depth: 2
  md_document:
    toc: yes
    toc_depth: 2
    variant: markdown
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
  word_document: default
graphics: yes
header-includes:
- \usepackage[portuguese]{babel}
- \usepackage{lscape}
- \usepackage{wallpaper}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[CO,CE]{}
- \fancyfoot[CO,CE]{Atlas da Radiação Solar da ilha da Madeira}
- \fancyfoot[LE,RO]{\thepage}
email: ricardo88faria@gmail.com
documentclass: article
---


```{r setup, include=FALSE}

#rmarkdown templates
library(tufte)
library(rticles)

library(shiny)
library(knitr)
library(pander)
library(kfigr)
library(Cairo)
library(captioner)
library(ggplot2)
library(reshape2)

library(viridisLite)
library(h5)
library(fields)
library(maptools)
library(sp)

library(ggmap)
library(RColorBrewer)

# color for radiation
rgb.palette.rad <- colorRampPalette(c("dodgerblue", "springgreen2", "yellow2", "orange", "tomato1", "violetred4", "purple"), space = "rgb")

# turn antialias off in osx used dev="png", dev.args=list(type="cairo") in knitr::opts_chunk$set because of antialias problem in osx
#quartz(antialias = F)

#library(knitcitations); cleanbib()
#cite_options(citation_format = "pandoc", check.entries=FALSE)
knitr::opts_chunk$set(echo = TRUE, dpi = 100, fig.align = 'center', fig.lp = 'fig:')
#knitr::opts_chunk$set(echo = TRUE, dpi = 100, fig.align = 'center', fig.lp = 'fig:', dev.args=list(type="cairo")) # dev = 'CairoPDF',
#knitr::opts_chunk$set(, dev = 'pdf')
load("../output/data.RData")
load("../output/data_coords.RData")
load("../output/data_merge.RData")

source("../matrix_rotation.R")

options(knitr.table.format = 'pandoc')

proj <- CRS("+proj=longlat +datum=WGS84 +towgs84=-160.410,-21.066,-99.282,2.437,-17.250,-7.446,0.168 +wktext +no_defs ") #CRS('+proj=longlat +datum=WGS84')
land <- readShapeSpatial("../input/map/PRT_adm2.shp", proj4string = proj)
#land_cities <- readShapePoly("../input/map/PRT_adm2.shp", proj4string = proj)

```


# Introdução

***

A realização do estudo do Atlas da Radiação Solar da ilha da Madeira, teve iniciativa no estágio do Eng. Ricardo Faria no [LREC](<http://www.lrec.pt>). Este novo Atlas foi realizada com novos modelos matemáticos, [WRF](<http://www.wrf-model.org>) para modelação do clima e o ReSun^TM^ para modelar a distribuição do recurso solar, em plano horizontal, de modo a identificar de regiões com maior potencial solar, este último é usado com a colaboração da Empresa [Megajoule Inovação](<http://megajoule.pt>).


# Localização e Descrição

***

A região em estudo é a ilha da Madeira, que é a principal ilha do arquipélago da Madeira, situado no oceano Atlântico, a sudoeste da costa portuguesa. Encontra-se entre as longitudes -17.3º a -16.64º e latitudes 32.6º a 32.9º. O ponto culminante situa-se no Pico Ruivo, 1.862 m de altura, a ilha é composta por um perímetro	179.3 km e área de 742.41  km^2^.
O [LREC](<http://www.lrec.pt>) dispõe de uma vasta rede de Estações Meteorológicas Automáticas (EMA) distribuidas por toda a ilha, representada na `r figr("ggmap", TRUE, type="Fig.")` e  `r figr("est_tab", TRUE, type="Tab.")`.

```{r, echo=FALSE} 
#\ref{fig:ggmap}
```

```{r ggmap, echo=FALSE,  message=FALSE, anchor = "Figura", fig.cap = "Localização da posição das EMAS que pertencem ao LREC", fig.retina=1, dpi=100, fig.width=13, fig.height=9}

data <- fortify(locs)
lon_coords <- long[length(long)/2]
lat_coords <- lat[length(lat)/2]
colors <- brewer.pal(9, "BuGn")

mapImage <- get_map(location = c(lon = lon_coords, lat = lat_coords),
  color = "color",
  source = "google",
  maptype = "satellite",
  zoom = 10)

ggmap(mapImage) +
      geom_point(data = data, aes(x = lon, y = lat, fill = loc, color = loc, group = loc), # color = loc
             size = 3, show.legend = T,
             alpha = 1) +
      scale_color_brewer(palette="Paired") +
      theme_bw() +
      labs(x = "Longitude [º]", y = "Latitude [º]")
      
```


```{r est_tab, echo=FALSE, message=FALSE, results='asis', anchor = "Tabela"}

kable(data, caption = 'Localização das EMAS em latlong [º]', align = "c")

```


## Clima 

Devido à sua latitude, a ilha da Madeira apresenta todas as características de ilha subtropical, caracteristicamente a costa Norte apresenta um clima temperado, enquanto a Sul denota-se mais subtropical. Em certos pontos da costa sul, as temperaturas médias anuais atingem valores acima dos 20 graus celsius. A temperatura da água do mar, varia entre os 26 de verão e os 17 de inverno. Os ventos predominantes são de oeste a noroeste no inverno, e de nordeste no verão (alíseos). A precipitação anual varia de 500 mm no sudeste da ilha aos mais de 2000 mm nas encostas norte.


## Topografia

A ilha da Madeira apresenta uma topografia muito montanhosa, com profundos vales incrustados entre os picos e suas caraterísticas falésias. A ilha do Porto Santo, apresenta uma topografia muito menos complexa em comparação à ilha da Madeira. A `r figr("topography", TRUE, type="Fig.")`representa a topografia complexa da ilha da Madeira com isolinhas.

```{r topography, echo=FALSE, message=FALSE, fig.cap="Topografia com isolinhas de Altura [m].", anchor = "Figura", fig.retina=1, dpi=100, fig.width=13, fig.height=9}

contour(long, lat, t(hgt), asp =1.1, col = terrain.colors(21), lwd=0.4, labcex=0.5, levels = c(.1, seq(min(hgt), max(hgt), length.out = 21)), xlab = 'Longitude [°]', ylab = 'Latitude [°]')
grid(NULL,NULL,lty = 5, lwd = 0.5)

```


# Recurso da Energia Solar

***

A radiação solar incidente na superfície terrestre resulta de uma complexa interacção entre atmosfera e a superfície. Numa escala mais global, fazem-se notar os gradientes da latitude causados pela geometria da terra e pelo seu movimento relativo ao sol (translação e rotação). Numa escala regional e até local, a morfologia do terreno é o maior factor de modificação da distribuição da radiação solar, variando em resposta à elevação, inclinação da superfície, orientação e sombreamento. A atenuação atmosférica, efeitos de dispersão e absorção pelos gases, partículas sólidas e líquidas, bem como a nebulosidade, agem como factores depreciativos dos valores de radiação.
A radiação que chega à superfície terrestre é selectivamente atenuada pela atmosfera, sendo a radiação directa a componente que não é reflectida nem dispersa. A radiação que é dispersa origina a radiação difusa e, por fim, uma pequena parte é reflectida (apenas em superfícies inclinadas) causando a radiação reflectida. Estas três componentes da radiação juntas, dão origem à radiação global ou onda curta.
Dada a atenuação da radiação, a quantidade de energia que actualmente chega à Terra, habitualmente, não excede os 70 % daquela que se encontra fora da nossa atmosfera, designada de extraterrestrial. Comummente as regiões de baixa latitude e especialmente com climas secos, expressam, tipicamente, os índices de radiação médios mais altos.
Dependendo da tecnologia empregue para transformação da energia solar, poderemos ter uma transformação de todas as componentes da radiação ou de apenas uma. A insolação (irradiação ou radiação) recebida por um painel solar apreende todas as componentes, todavia, os sistemas de transformação que empregam concentração óptica (exemplo dos concentradores parabólicos), apenas podem usar a radiação directa normal para transformação.
O recurso solar num dado local é caracterizado pela radiação ou irradiação solar por unidade de área, geralmente expressa em quilowatt-hora ou megajoule por metro quadrado por dia ou por ano.


# Metodologia

***

Metodologia a usar na elaboração do novo Atlas Solar do Arquipélago da Madeira:
A estimativa do recurso solar será executada pelo código de simulação ReSun^TM^ (Pereira et al 2013) na sua variante de modelação, que se encontra capacitada para modelar os principais factores que afectam a magnitude do recurso solar, permitindo assim apurar a verdadeira valia da distribuição do recurso solar de uma forma mais detalhada. A modelação ReSun^TM^ faz uso de resultados das simulações meteorológicas WRF (Weather Research & Forecasting Model), num procedimento designado de downscaling, que engloba simulações idealizadas (céu limpo) nos pontos de uma malha de cálculo (mapeamento) ou pontos discretos de interesse (séries dados). São usadas técnicas de decomposição da radiação e métodos de interpolação por recurso a distância efetivas.
As simulações a usar na obtenção do Atlas Solar serão realizadas para um período temporal equivalente a um ano meteorológico típico, selecionado a partir das Estações Meteorológicas Automáticas distribuídas pelo arquipélago da Madeira e com auxilio, se necessário, de dados provenientes de uma análise retrospetiva do programa MERRA (Modern-Era Retrospective Analysis For Research And Applications). Os dados das estações serão processados e analisados com o módulo QC (Solar Data Quality Check) do ReSun^TM^, onde se fará uma análise de consistência das medições de radiação global das estações. Será também realizada uma averiguação da performance do ReSun^TM^ para um ano a selecionar a partir das medições locais.


## Simulações Mesoescala

O uso de resultados de mesoescala para alimentar o modelo ReSunTM tem como objetivo integrar os efeitos de atenuação da radiação solar provocada pela formação de nebulosidade.
O modelo de mesoescala utilizado foi o WRF (Weather Research and Forecasting System, UCAR) versão 3.3.5.
Este modelo de mesoescala é atualmente utilizado por inúmeras instituições por todo o mundo, e a sua versatilidade garante uma personalização completa para uma vasta gama de estudos. Este sistema de modelação numérica consiste em vários módulos especialmente criados para assimilar dados de observações e simular condições atmosféricas, resolvendo várias equações que descrevem a dinâmica e termodinâmica dos processos climáticos em áreas limitadas [@skamarock2005];[@lo2007].
Os dados climáticos de entrada utilizados para alimentar as condições de fronteira do modelo WRF foram os NCEP FNL (Final) Operation Global Analysis [@gfs2003]. Este projeto, concebido pelo Global Data Assimilation System (GDAS), reúne dados de observações globais do programa Global Telecommunications System (GTS), e de outras fontes observacionais como, tradicionais mastros meteorológicos, boias, satélites entre outros. Os dados FNL são concebidos com o mesmo modelo com o qual o National Center for Environment Prediction (NCEP) opera, o Global Forecast System (GFS). Estes dados descrevem a atmosfera em vários níveis verticais, com uma resolução horizontal de 1o (~110km), sendo utilizados em estudos de larga escala e para inicialização de simulações de menor escala.
Os dados das fronteiras físicas são oriundos do SRTM30 DEM (United States Geological Survey), na versão 2.0. Esta base de dados consiste num modelo de elevação digital (DEM – Digital Elevation Model) que fornece informação sobre a elevação do terreno num domínio horizontal de 30 arco segundos (aproximadamente 1 km), obtida através de interferometria por radar, com cobertura de 80% da massa terrestre [@farr2000].
Os dados sobre a cobertura do solo são oriundos do Global Land Cover Characteristics Database (USGS, National Center for Earth Resources Observation and Science – EROS, Joint Research Centre of the European Commission). Tais dados consistem numa série de informações globais sobre as características de cobertura do solo com resolução horizontal de 1 km, concebidos para utilização numa ampla gama de aplicações de investigação ambiental e modelação, adquiridos de observações globais realizadas entre Abril de 1992 e Março de 1993 do Advanced High Resolution Radiometer, a bordo dos satélites da série NOAA [@sellers1996];[@skamarock2005];[@gemmill2007].
Dados de Temperatura da Superfície do Mar (SST – Sea Surface Temperature) são extraídos do Daily Real-Time, Global Sea Surface Temperature Analysis (RTG-SST), disponibilizado pelo National Centers for Environment Prediction (NCEP), National Weather Service (NWS/NOAA). Esta base de dados consiste numa combinação diária de dados in-situ e medições do Advanced Very High Resolution Radiometer (AVHRR) SST analysis, numa grelha de 0.5 graus de resolução [10].
As configurações e parametrizações do modelo de mesoescala seguem conclusões retiradas aquando do desenvolvimento do acoplamento WRF/ReSunTM [@pereira2013].


## Descrição do modelo ReSun

O modelo ReSun^TM^, _Solar Modelling on Coupling Techinques with Mesoscale Simulations_, Pereira et al 2013, tem sido desenvolvido e testado desde 2009 na MEGAJOULE INOVAÇÃO e conta também com a colaboração do departamento de Física da Universidade de Aveiro. O ReSun^TM^ usa resultados das simulações do modelo WRF, para correção das simulações idealizadas (céu limpo) nos pontos da malha ReSun^TM^. São usadas técnicas de decomposição da radiação e métodos de interpolação, por recurso a distância efetivas, para o transporte das quantidade de correção para os pontos da malha de cálculo do Re.SunTM.
Os factores de correção da simulação de céu limpo da malha do ReSun^TM^ podem ser estimados através de duas formas, em termos de índice solar global (Radiação Global WRF/Radiação Global Céu Limpo) ou índice solar directo (Radiação Direta WRF / Radiação Direta Céu Limpo) e difuso (Radiação Global WRF / Radiação Difusa Céu Limpo).
As técnicas de decomposição da radiação global para obtenção da radiação direta e difusa, é conseguida através da utilização do modelo DirInt (Perez R., Ineichen P., Maxwell E., Seals R., Zelenka A. , 1992) ou BRL ( Boland et al. 2012).
Os efeitos do terreno estão programados para serem contabilizados através do método proposto por Dozier et al. (1980). O ReSun^TM^ integra dois modelos de simulação em condições de céu limpo, o modelo ESRA (European Solar Radiation Atlas) proposto por Rigollier et al. (2000) e o modelo Simplified SOLIS proposto por Ineichen (2008). O modelo ESRA permite duas formulações para a estimativa da radiação solar em condições de céu limpo: irradiância (W/m^2) e irradiação (Wh/m^2.dia). O modelo SOLIS simplificado calcula a irradiância em céu limpo com base em cálculos de transferência radiativa e na relação de Lambert – Beer.
O modelo ReSun^TM^ apresenta a capacidade de integrar informação atual do estado da pureza da atmosfera a ser ingerida pelo modelo de céu limpo. Os aerossóis ou o TL2 (Linke Turbidity para uma massa de ar igual a 2) são parâmetros de caracterização do estado de pureza e podem ser obtidos a partir do programa SODA (Solar Radiation Data), ou derivados a partir da MACC Re-analysis (Monitoring Atmospheric Composition & Climate) projeto da ECMWF (European Centre for Medium Range Weather Forecast). O projeto SODA possui valores mensais de TL2 disponíveis para o mundo todo, resultante de um levantamento de diferentes fontes de informação, Redmund et al. , 2003. O projeto MACC Re-Analysis não possui informações de TL2 para uso directo, contudo podem ser derivadas utilizando informação do profundidade óptica dos aerossóis para diferentes comprimentos de onda e conjugando dados de coluna de água precipitável. No ReSun^TM^ a estimativa de TL2 usando informação da MACC é possível através de uma de duas formulações de cálculo: Redmund et al. 2003 ou Pierre Ineichen 2008 que considera um ajuste multivariável calculado a partir da irradiação directa estimada com o modelo Solis em conjunto com a fórmula pyrheliometric de Kasten (1996).
Dependendo do modelo do céu limpo utilizado existem diferentes informações para caracterizar a pureza atmosfera. No caso do modelo de ESRA as equações fazem uso da informação de TL2. A versão simplificada do modelo de Solis (Ineichen, 2008), utiliza como entrada a informação da profundidade óptica dos aerossóis (Aerosol Optical Depth, AOD) para um comprimento de onda de 700 nm (AOD700).
Para efeitos de simulação o ReSun^TM^ assume valores de cadência diária de AOD ou TL2. Assim sendo temos que os valores mensais de SODA são interpolados linearmente de mensal para diário e os valores médios diários da MACC resultam de uma frequência de amostragem de 3 horas.


### Ano Meteorológico Típico

Em termos gerais, a previsão da performance a longo prazo de qualquer sistema energético solar depende da existência de uma extensa e fiável base climática local. Teoricamente, esta análise energética deve ser realizada usando-se vários anos de dados climáticos, o que na maior parte das vezes não é possível dada a sua inexistência. Isto leva-nos a ter de recorrer a informação proveniente de bases climáticas de larga escala obtidas através de modelos de simulação avançados. Contudo, o uso de períodos extensões para simulação são computacionalmente exigentes, tornando as análises demasiado morosas e dispendiosas. A variabilidade inter anual das condições climáticas motiva a necessidade de se derivar uma base que represente as condições médias de longo prazo num único ano. Comummente isto é conseguido através de um ano meteorológico típico (Typical Meterological Year, TMY) constituído pela informação dos 12 meses mais representativos.
O método estatístico utilizado para estimativa do TMY foi o de Filkenstein – Shafer (FS) devidamente implementado pela [Megajoule Inovação](<http://megajoule.pt>) [@finkelstein1971]. O método baseia a seleção dos meses através de uma análise da frequência cumulativa da média diária dos valores de Radiação Global e Temperatura para cada um dos meses de um ano civil, Janeiro a Dezembro. De uma forma resumida, a escolha do ano para cada um dos meses resultará do que apresentar o menor somatório de erros diários de frequências cumulativas de um mês em especifico, de um dado ano, face ao longo termo do mês. De salientar que os erros obtidos para cada uma das variáveis incluídas na análise do TMY são sujeitas a uma ponderação utilizando-se pesos diferentes, 70% e 30%, radiação solar global e temperatura, respetivamente.
Para obtenção de um TMY que caracterize de uma forma fiável a distribuição da radiação global de longo prazo e que reflita a variabilidade climática na área de interesse, recorreu-se a dados horários de radiação solar global e temperatura provenientes da Reanálise MERRA da NASA. Foram extraídos 30 pontos nativos da malha MERRA, distribuídos ao longo da área de interesse, para os últimos 10 anos (2005 – 2015) para apoio à seleção de 12 meses típicos que compõem o TMY.
Após extração da informação para os 30 pontos, foi realizada uma integração da informação de cada ponto para um único ficheiro de forma a permitir a análise estatística para a área de interesse. A `r figr("tmy_tab", TRUE, type="Tab.")` apresenta a informação relativa anos obtidos para cada um dos meses do TMY e o valor médio do erro absoluto ponderado (Radiação e Temperatura) face ao longo termo.

```{r cob_tab, echo=FALSE, message=FALSE, results='asis', anchor = "Tabela"}

file_csv <- Sys.glob("ReSun/Analysis_tmy_total.csv")
tmy_values <- read.csv(file_csv, sep = ";")

tx_cob <- data.frame(tax_cob_tmy = tmy_values[47:54,2:13])
colnames(tx_cob) <- c(months_name[2:13])
row.names(tx_cob) <- tmy_values[47:54,1]

kable(tx_cob, caption = 'Taxa de cobertura de Dados das EMAS entre 2005 e 2015', align = "c")

```

Após realizar a análise das EMAS com o Quality Check do ReSun^TM^, verifica-se que as estações de Machico (MACH) e Santana (STNA) apresentam uma taxa de cobertura de dados muito baixa ao longo do ano de 2005 a 2015. Estas foram retiradas para o cálculo final do TMY, de modo a obter maior fiabilidade nos valores finais deste.

```{r tmy_tab, echo=FALSE, message=FALSE, results='asis', anchor = "Tabela"}

tmy_tab <- data.frame(#Mês = months_name[2:13], 
                      Ano = as.numeric(tmy_values[2,2:13]),
                      Erro_abs = as.numeric(tmy_values[14,2:13])*100,
                      Rad_sol = as.numeric(tmy_values[26,2:13]))
colnames(tmy_tab) <- c("Ano", " Erro abs. [%]", "Rad. Sol. [W/m^2]")
row.names(tmy_tab) <- months_name[2:13]

kable(tmy_tab, caption = 'Dados do TMY', align = "c")

```

Na `r figr("tmy1", TRUE, type="Fig.")`, `r figr("tmy2", TRUE, type="Fig.")`, `r figr("tmy3", TRUE, type="Fig.")`, `r figr("tmy4", TRUE, type="Fig.")`, `r figr("tmy5", TRUE, type="Fig.")` e `r figr("tmy6", TRUE, type="Fig.")` pode ser consultada a evolução da frequência cumulativa diária da radiação global e Temperatura para cada um dos meses do TMY.

![Evolução da frequência cumulativa diária da radiação global nos meses de Janeiro a Abril do TMY.](ReSun/tmy/Irradiance_CDF_Monthly_Ja_Ap.png "tmy1")

![Evolução da frequência cumulativa diária da radiação global nos meses de Maio a Agosto do TMY.](ReSun/tmy/Irradiance_CDF_Monthly_My_Ag.png "tmy2")

![Evolução da frequência cumulativa diária da radiação global nos meses de Setembro a Dezembro do TMY.](ReSun/tmy/Irradiance_CDF_Monthly_Sp_Dc.png "tmy3")

![Evolução da frequência cumulativa diária da temperatura nos meses de Janeiro a Abril do TMY.](ReSun/tmy/Temperature_CDF_Monthly_Ja_Ap.png "tmy4")

![Evolução da frequência cumulativa diária da temperatura nos meses de Maio a Agosto do TMY.](ReSun/tmy/Temperature_CDF_Monthly_My_Ag.png "tmy5")

![Evolução da frequência cumulativa diária da temperatura nos meses de Setembro a Dezembro do TMY.](ReSun/tmy/Temperature_CDF_Monthly_Sp_Dc.png "tmy6")


### Profundidade Ótica dos Aerossóis

A profundidade ótica dos aerossóis, mais conhecida por Aerosol Optical Depth, AOD, é conhecida por ser uma variável crítica de entrada em modelos de radiação solar, e determina parcialmente o grau de precisão das estimativas de radiação solar [@gueymard2012]. Em termos globais, a nebulosidade é a principal responsável pela depreciação da magnitude da radiação solar. Todavia, em condições de céu limpo, AOD, torna-se no principal controlador. Nas áreas onde as condições de céu limpo acontecem com maior frequência, torna-se imperativa a sua consideração no espaço e tempo. Além do efeito na estimativa da radiação solar, os aerossóis desempenham um papel determinante na formação de nebulosidade e de modificação das propriedades microfísicas das nuvens. A sua densidade, composição química e tamanho influência o albedo (percentagem de reflecção) e tempo de vida das nuvens, bem como, a taxa e quantidade de precipitação (Abel et al., 2005; Lohmann and Feichter, 2005). Os aerossóis estão intrinsecamente associadas a poeiras transportadas pelas correntes globais de vento, partículas de carbono e sulfatos produzidas por incêndios, tipos de solo, atividades industriais e até mesmo partículas de sais marinhos resultantes da agitação marítima.
Neste estudo a radiação solar considera informação da Turbidez atmosférica para uma massa de ar igual a 2, TL2, proveniente do programa SODA (Solar Radiation Data), atualizada para cada um dos meses do TMY e posteriormente interpolada para uma frequência diária.
O projeto SODA contém informação dos valores mensais da TL2, provenientes de uma sobreposição de várias fontes e através de estimativas diretas e indiretas da Turbidez atmosférica para uma massa de ar igual a 2, METEOTEST (Redmund et al ., 2003).
Face à utilização do modelo Simplified Solis, que faz uso de valores AOD para descrever a pureza da atmosfera, existe a necessidade da conversão de valores de TL2 em valores de AOD para um comprimento de onde de 700nm. A formulação proposta por Ineichen, Pierre, 2008 foi usada para o propósito de conversão.


### Dados topográficos e horizontes

Para definição digital da topografia, foram utilizados dados dos modelos digitais de elevação provenientes do projeto SRTM. A resolução final da grelha de altimetria a utilizar nos cálculos foi de 100 m, resultando nas `r figr("srtm_topo_mad", TRUE, type="Fig.")` e `r figr("srtm_topo_ps", TRUE, type="Fig.")`.

```{r srtm_topo_mad, warning=F, echo=FALSE, message=FALSE, fig.cap="Topografia SRTM a 100m de resolução da ilha da Madeira.", anchor = "Figura", fig.retina=1, dpi=500, fig.width=13, fig.height=9, dev="png", dev.args=list(antialias = "none")}

hgt[hgt == 0] <- NA

filled.contour(long, lat, t(hgt),  col = terrain.colors(20), asp = 1, # nlevels = 400, #axes = F #(12), nlev=13,
               plot.title = title(xlab = 'Longitude [°]', ylab = 'Latitude [°]'),
               plot.axes = {
                 axis(1); 
                 axis(2); 
                 grid(NULL,NULL,lty = 5, lwd = 0.5);
                 plot(land, add = T); text(getSpPPolygonsLabptSlots(land), labels=as.character(land$NAME_2), cex=.5)
                 },
               key.title = title(main = as.expression(paste("[m]"))))

```

```{r srtm_topo_ps, warning=F, echo=FALSE, message=FALSE, fig.cap="Topografia SRTM a 100m de resolução da ilha do Porto Santo.", anchor = "Figura", fig.retina=1, dpi=500, fig.width=13, fig.height=9, dev="png", dev.args=list(antialias = "none")}

hgt_ps[hgt_ps == 0] <- NA

filled.contour(long_ps, lat_ps, t(hgt_ps), col = terrain.colors(31), asp = 1, # nlevels = 400, #axes = F #(12), nlev=13,
               plot.title = title(xlab = 'Longitude [°]', ylab = 'Latitude [°]'),
               plot.axes = {
                 axis(1); 
                 axis(2); 
                 grid(NULL,NULL,lty = 5, lwd = 0.5);
                 plot(land, add = T); text(getSpPPolygonsLabptSlots(land), labels=as.character(land$NAME_2), cex=.5)
                 },
               key.title = title(main = as.expression(paste("[m]"))))

```

A descrição direcional das elevações em graus, horizontes, foi realizada segundo o método proposto por Dozier et al.1980 e teve por base a informação de altimétrica na resolução de 100m. Na estimativa dos horizontes foram utilizados 96 sectores direcionais permitindo estimar os efeitos de sombreamento e consequente influência sobre o défice de energia.
Na `r figr("hori_ps_N", TRUE, type="Fig.")` pode ser consultado com maior detalhe a informação topográfica de entrada, e o mapa de horizontes para a direção de 90º (Sul) para a ilha da Madeira e Porto Santo.

```{r hori_ps_N, echo=FALSE, message=FALSE, fig.cap="Cálculo dos horizontes, direção de Norte e Este no Porto Santo.", anchor = "Figura", fig.retina=1, dpi=500, fig.width=13, fig.height=9, fig.show='hold', dev="png", dev.args=list(antialias = "none")}

hor_file_ps <- h5file("ReSun/horiz/PTS_100x100/hor_mapcal_96.mat")
hor_mat_ps <- hor_file_ps["matrixtotalf"][]
hor_file_mad <- h5file("ReSun/horiz/MAD_100x100/hor_mapcal_96.mat")
hor_mat_mad <- hor_file_mad["matrixtotalf"][]

#library(plotly)
#plot_ly(z = t(hor_mat_ps[4,,]), type = "contour", width = "100%", height = "100%")
#plot_ly(z = t(hor_mat_ps[48,,]), type = "contour", width = "100%", height = "100%")

#hor_mat[hor_mat == 0] <- NA
#image.plot(hor_mat_ps[4,,], col = viridis(n = 21, alpha = 1, begin = 0, end = 1, option = "D"), axes=T, legend.lab="[m/s]") #,  xlab='Longitude [°]', ylab='Latitude [°]'

filled.contour(hor_mat_mad[51,,], col = viridis(n = 27, alpha = 1, begin = 0, end = 1, option = "A"), # nlevels = 400, #axes = F #(12), nlev=13,
               plot.axes = {
                 axis(1); 
                 axis(2); 
                 grid(NULL,NULL,lty = 5, lwd = 0.5)
                 },
               key.title = title(main = as.expression(paste("[º]"))),
               plot.title = title(main = "Horizontes ilha da Madeira - Sul"))

filled.contour(hor_mat_ps[51,,], col = viridis(n = 27, alpha = 1, begin = 0, end = 1, option = "A"), # nlevels = 400, #axes = F #(12), nlev=13,
               plot.axes = {
                 axis(1); 
                 axis(2); 
                 grid(NULL,NULL,lty = 5, lwd = 0.5);
                 },
               key.title = title(main = as.expression(paste("[º]"))),
               plot.title = title(main = "Horizontes ilha do Porto Santo - Sul"))

```


### Configuração Numérica ReSun^TM^

Após conclusão das simulações mesoescala percussoras, com o objetivo de resolver todas as interações meteorológicas, ficaram disponíveis variáveis como: Short Wave Radiation, Temperature, Vapour Mixed Ratio e Surface Pressure para posterior ingestão pelo modelo ReSun^TM^. A estimativa da irradiação média diária em plano horizontal com o modelo ReSun^TM^, teve por base a ingestão diária de ficheiros com uma cadência de 10 minutos, sendo este o passo de tempo utilizado em cálculo. A `r figr("resun_tab", TRUE, type="Tab.")` resume a configuração numérica utilizada nas simulações ReSun^TM^.

```{r resun_tab, echo=FALSE, message=FALSE, results='asis', anchor = "Tabela"}

tmy_tab <- data.frame(#Mês = months_name[2:13], 
                      Modelo = c("WRF",
                                 "Modelo de Céu Limpo", 
                                 "AOD700nm / Turbidez (Massa de Ar 2)",
                                 "Modo de Correcção da Radiação de Céu Limpo",
                                 "Modelo de Decomposição",
                                 "Pontos da malha WRF usados em interpolações"
                                 ),
                      Configuração = c("Resolução de 5km; 
                                       Dados Climáticos FNL; 
                                       Informação do terreno SRTM; 
                                       Cobertura do Global Land Cover", 
                                       "Simplified Solis Model",
                                       "Informação de cadência diária dos Aerossóis para profundidade óptica de 700 nm,
                                       derivada a partir da TL2 da base SODA",
                                       "Fração Solar Global",
                                       "Skartveit and Olseth model, 1998",
                                       "4 (Interpolação tri-linear usando o conceito de distâncias efectivas com métodos de peso segundo Shepard)"))
colnames(tmy_tab) <- c("", "Configuração")
#row.names(tmy_tab) <- months_name[2:13]

#pandoc.table(tmy_tab, caption = 'Configuração ReSun^TM^.', style = "rmakdown", justify = "left")
pander(tmy_tab, caption = 'Configuração ReSun^TM^.', keep.line.breaks = TRUE, style = 'grid', justify = 'left')
```


## Correção dos Valores de Radiação Global

Considerando que o WRF, demostra uma tendência em sub estimar o valor da radiação com a evolução da altura topográfica, será usado preditores de modo a corrigir/atenuar essa sobrevalorização.
O preditor para corrigir os valores de radiação global, é calculado através de valores de erro absoluto (rMB[%]) de radiação global no plano horizontal simulados no ReSun, nos pontos em que temos valores (EMAS) reais de modo a poder comparar esta evolução. Valores esses que estão apresentados na `r figr("corr_tab", TRUE, type="Tab.")`.

```{r corr_tab, echo=FALSE, message=FALSE, results='asis', anchor = "Tabela"}

file_csv <- Sys.glob("ReSun/ReSun_Tests_Setup*.csv")
corr_values <- read.csv(file_csv, sep = ",")
corr_values_ggplot <- data.frame()

corr_values <- corr_values[c(1:11), c(1, 4, 8, 9)] 


# adicionar valores da simulacao ReSun_D03 e corrigidos para os pontos das estaçoes para comparaçao
corr_values$ReSun_D03 <- c(179.3193, 213.8, 155.7298, 204.6529, 203.0712, 167.71, 202.2721, 164.1528, 192.5755, NA, NA)
corr_values$ecorr <- corr_values[10, 4]*corr_values[, 4] + corr_values[11, 4]
#corr_values$corr <- corr_values$ecorr
corr_values[c(10:11), c(5)] <- NA
corr_values$ReSun_D03_corr <- corr_values$ReSun_D03*(1-corr_values$ecorr/100)

# calcular erro absoluto e percentil
corr_values$ecorrperc <- abs((corr_values$ReSun_D03_corr - corr_values$IGH)/corr_values$IGH*100)
corr_values$per50 <- quantile(corr_values$ecorrperc[1:9], probs = .5)
corr_values$per80 <- quantile(corr_values$ecorrperc[1:9], probs = .8)
corr_values$RMS <- sqrt(mean(corr_values$ecorrperc[1:9]^2))
corr_values$SD <- sd(corr_values$ecorrperc[1:9], na.rm = FALSE)

corr_values[c(1:9), -1] <- round(corr_values[c(1:9), -1], digits = 1)
corr_values_ggplot <- corr_values
colnames(corr_values) <- c("EMA", "Erro abs. [W/m^2]", "Rad. Sol. [W/m^2]", "Altura [m]",  "ReSun D03 [W/m^2]", " Erro abs. corr. [W/m^2]", "ReSun D03 corr. [W/m^2]", "Erro abs. [%]", "Per50", "Per80", "RMS", "SD")

kable(corr_values[1:9,1:8], caption = 'Valores de Erro Absoluto, rMB[%], para as EMAS em estudo.', align = "c", digits = 3)

```

```{r corr_graph, warning=F, echo=FALSE, message=FALSE, fig.cap="Regressão linear de rMB da radiação global em função da Altura", anchor = "Figura", fig.retina=1, dpi=100, fig.width=7, fig.height=4}

eq <- paste0("y=", round(corr_values[11,4], digits = 5), "x", round(corr_values[10,4], digits = 5))

ggplot() +
  geom_point(data = corr_values_ggplot[c(1:9),], aes(x = z, y = min_D03, color = X)) +
  #geom_point(aes(x = z, y = ecorr, color = X)) +
  labs(title = "rMB da Rad. Global VS Altura", x ="Cota [m]", y ="rMB [%]", colour = "EMA", size = 30) +
  geom_abline(aes(intercept = corr_values[11,4], slope = corr_values[10,4]), color = "black") +
  annotate("text", label = eq, x = 1400, y = 0, size = 3, colour = "black") +
  scale_color_brewer(palette="Paired")

```

Este preditor segue uma regressão linear de rMB em função da radiação global em função da altura, representado na `r figr("corr_graph", TRUE, type="Fig.")`.


# Resultados

***

A aplicação da metodologia detalhada anteriormente conduziu às estimativas da distribuição do recurso solar para a área de interesse.
A `r figr("IGPH_mad", TRUE, type="Fig.")`, `r figr("IGPH_ps", TRUE, type="Fig.")` que se segue apresentam a disponibilidade da média anual da radiação global diária em plano horizontal para o ano meteorológico típico na Madeira e Porto Santo.


\blandscape
```{r IGPH_mad, warning=F, echo=FALSE, message=FALSE, fig.cap="Radiação Global no plano horizontal para a ilha da Madeira, par o TMY.", anchor = "Figura", fig.retina=1, dpi=500, fig.width=13, fig.height=9, dev="png", dev.args=list(antialias = "none")}

# croped use z matrix:
# mat_rot(matrix(raster_IGPH[], ncol = raster_IGPH@ncols, nrow = raster_IGPH@nrows, byrow = T))
# non croped use z matrix:
# t(IGPH[,,1])

filled.contour(long, lat, mat_rot(matrix(raster_IGPH[], ncol = raster_IGPH@ncols, nrow = raster_IGPH@nrows, byrow = T)), 
               color = rgb.palette.rad, levels = seq(floor(min(raster_IGPH$IGPH_tot[], na.rm = T)), round(max(raster_IGPH$IGPH_tot[], na.rm = T)+10, -1), 10), #viridis(n = 17, alpha = 1, begin = 0, end = 1, option = "A"), 
               asp = 1, xlim = range(long, finite = TRUE), ylim = range(lat, finite = TRUE), # nlevels = 400, #axes = F #(12), nlev=13,
               plot.axes = {
                 axis(1); 
                 axis(2); 
                 grid(NULL,NULL,lty = 5, lwd = 0.5);
                 plot(land, add = T); text(getSpPPolygonsLabptSlots(land), labels=as.character(land$NAME_2), cex=.5)
                 },
               key.title = title(main = as.expression(paste("[W/m^2]"))),
               plot.title = title(main = "Radiação Global Madeira", xlab = 'Longitude [°]', ylab = 'Latitude [°]'))

```
\elandscape


\blandscape
```{r IGPH_ps, warning=F, echo=FALSE, message=FALSE, fig.cap="Radiação Global no plano horizontal ilha do Porto Santo, par o TMY.", anchor = "Figura", fig.retina=1, dpi=500, fig.width=13, fig.height=9, dev="png", dev.args=list(antialias = "none")}

filled.contour(long_ps, lat_ps, mat_rot(matrix(raster_IGPH_merg[], ncol = raster_IGPH_merg@ncols, nrow = raster_IGPH_merg@nrows, byrow = T)), 
               color = rgb.palette.rad, levels = seq(floor(min(raster_IGPH$IGPH_tot[], na.rm = T)), round(max(raster_IGPH$IGPH_tot[], na.rm = T)+10, -1), 10), #viridis(n = 17, alpha = 1, begin = 0, end = 1, option = "A"), 
               asp = 1, xlim = range(long_ps, finite = TRUE), ylim = range(lat_ps, finite = TRUE), # nlevels = 400, #axes = F #(12), nlev=13,
               plot.axes = {
                 axis(1); 
                 axis(2); 
                 grid(NULL,NULL,lty = 5, lwd = 0.5);
                 plot(land, add = T); text(getSpPPolygonsLabptSlots(land), labels=as.character(land$NAME_2), cex=.5)
                 },
               key.title = title(main = as.expression(paste("[W/m^2]"))),
               plot.title = title(main = "Radiação Global Porto Santo", xlab = 'Longitude [°]', ylab = 'Latitude [°]'))

```
\elandscape


# Validação dos resultados

***

A incerteza associada aos resultados da modelação da radiação solar é sempre um processo complexo e dependente de inúmeras fontes que contribuem para a sua estimativa, sempre aproximada. Destaca-se que os principais controladores que afetam a modelação da radiação solar são essencialmente a nebulosidade e o estado de pureza da atmosfera. Para uma se proceder a uma validação do desempenho do modelo é necessária a existência de dados fidedignos e distribuídos ao longo de diferentes condições atmosféricas, o que na maior parte das vezes não acontece face a escassez de medições.
A ilha da Madeira embora apresente uma área relativamente pequena, esta é composta por uma topografia muito acidentada, que faz com que hajam microclimas e sazonalidade climática, estes casos tornam imperativo o uso de abordagens científicas mais sofisticadas para qualquer modelação energética que exija dados solares como entrada.
Na tabela `r figr("percentile_tab", TRUE, type="Tab.")` é apresentado as medidas estatísticas de erro médio relativo, rMB, Root Mean Square relativo, rRMS, desvio padrão relativo, rSTD, e o erro relativo absoluto máximo para diferentes cenários de probabilidade (50% e 80%), respetivamente.

```{r percentile_tab, echo=FALSE, message=FALSE, results='asis', anchor = "Tabela"}

tab <- corr_values[1,9:10]
row.names(tab) <- "Erro relativo absoluto máximo [%]"
colnames(tab) <- c("Probabilidade 50%", "Probabilidade 80%")

kable(tab, caption = 'Erro relativo absoluto máximo para diferentes cenários de probabilidade da validação ReSun.', align = "c", digits = 3)

```


# Considerações

***

Foram realizadas simulações computacionais a fim de se modelar por técnicas mais avançadas a disponibilidade da radiação solar global na horizontal sobre a áera da ilha da Madeira e Porto Santo.
As técnicas de modelação da radiação solar foram executadas pelo ReSun^TM^, fazendo uso de resultados de mesoescala com objetivo de integrar os efeitos da nebulosidade. Este é um processo em que o ReSun^TM^ faz uso das capacidades de modelação meteorológicas de larga escala, resolvidas pela mesoescala (WRF), para alimentar um processo de downscaling dinâmico que introduz um maior detalhe na caracterização da disponibilidade e magnitude da radiação solar.
Para caracterização da incerteza foram associados os resultados das 9 EMAS anteriormente apresentadas.


```{r, echo=FALSE}

# abrir shiny app
#shinyAppFile("../Shiny_app/app.R", options=list(width="100%", height=400))

```


# Bibliografia

***

---
references:
- id: skamarock2005
  title: A description of the Advanced Research WRF Version 2
  author:
  - family: Skamarock
    given: W. C., J. B. Klemp, J. Dudhia, D. O. Gill, D. M. Barker, W. Wang, and J. G. Powers
  container-title: 
  publisher: NCAR Tech Notes-468+STR
  type: article-journal
  issued:
    year: 2005

- id: lo2007
  title: Assessment of three dynamical climate downscaling methods using the Weather Research and Forecasting (WRF) model
  author:
  - family: Lo
    given: J. C.-F., Z.-L. Yang, and R. A. Pielke Sr
  container-title: 
  publisher: NCAR Tech Notes-468+STR
  type: article-journal
  issued:
    year: 2007

- id: gfs2003
  title: Global Climate and Weather Modeling Branch
  author:
  - family:
    given:
  container-title: The GFS Atmospheric Model
  publisher: NCEP OFFICE NOTE 442
  type: article-journal
  issued:
    year: 2003

- id: farr2000
  title: Shuttle Radar Topography Mission produces a wealth of data
  author:
  - family: Farr
    given: T.G., M. Kobrick
  container-title: Amer. Geophys. Union Eos
  publisher: NCEP OFFICE NOTE 442
  type: article-journal
  issued:
    year: 2000

- id: gemmill2007
  title: Daily Real-Time Global Sea Surface Temperature - High Resolution Analysis at NOAA/NCEP
  author:
  - family: Gemmill
    given: William, Bert Katz and Xu Li
  container-title: 
  publisher: NOAA / NWS / NCEP / MMAB Office Note Nr. 260
  type: article-journal
  issued:
    year: 2007

- id: sellers1996
  title: A revised land surface parameterization (SiB2) for atmospheric GCMs - Part I-model formulation
  author:
  - family: Sellers
    given: P.J., Randall, D.A., Collatz, G.J., Berry, J.A., Field, C.B., Dazlich, D.A., Zhang, C., Collelo, G.D., and Bounoua
  container-title: 
  publisher: Journal of Climate, v. 9
  type: article-journal
  issued:
    year: 1996

- id: finkelstein1971
  title:  Improved goodness-of-fit tests. Biometrika
  author:
  - family: Finkelstein JM
    given: Schafer RE.
  container-title: 
  publisher: Biometrika
  type: article-journal
  issued:
    year: 1971

- id: gueymard2012
  title: emporal variability in direct and global irradiance at various time scales as affected by aerosols
  author:
  - family: Gueymard
    given: C.A.
  container-title: Science Direct
  publisher: Solar Energy 86
  type: article-journal
  issued:
    year: 2012
        
- id: pereira2013
  title: Re.Sun^TM^ - Validation White Paper
  author:
  - family: Pereira
    given: Rui
  container-title: Comunicação Pessoal
  issued:
    year: 2013
---

